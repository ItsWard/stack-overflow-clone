env:
  PROJECT_NAME: server

name: Test Deploy

  
on:
  release:
    types: [push]
  push:
    branches: [main]
  workflow_dispatch:
  
jobs:
  build: 
    runs-on: ubuntu-latest
    permissions: 
      contents: read 
      packages: write  

    steps:
    - name: Checkout 
      uses: actions/checkout@v3   
      
    - name: Set up JDK 11 
      uses: actions/setup-java@v3 
      with:
        java-version: '11' 
        distribution: 'temurin' 
        

    - name: server build 
      run: |
        mkdir -p deploy
        cd server/
        chmod +x ./gradlew 
        ./gradlew clean build -x test
        mkdir -p before-deploy
        cp build/libs/*.jar before-deploy/
        cd before-deploy && zip -r before-deploy *
        mv server/before-deploy/before-deploy.zip deploy/$PROJECT_NAME.zip
      shell: bash
             
     
        
#     - name: Make zip file
#       run: zip -r ./$PROJECT_NAME.zip .        
#            pwd
#       shell: bash
        


#     - name: ssh deploy
#       uses: easingthemes/ssh-deploy@v2.2.11
#       with:
#         SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
#         REMOTE_HOST: ${{ secrets.SERVER_HOST }}
#         REMOTE_USER: ${{ secrets.SERVER_USER_NAME }}
#         REMOTE_PORT: ${{ secrets.SERVER_PORT }}
#         SOURCE: deploy/$PROJECT_NAME.zip
#         TARGET: /home/ward/
        
#     - name: executing remote ssh commands using ssh key
#       uses: appleboy/ssh-action@master
#       with:
#         host: ${{ secrets.SERVER_HOST }}
#         username: ${{ secrets.SERVER_USER_NAME }}
#         key: ${{ secrets.SERVER_SSH_KEY }}
#         port: ${{ secrets.SERVER_PORT }}
#         script: ./deploy.sh
